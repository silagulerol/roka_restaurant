<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Roka Restaurant - Amazing & Delicious Food</title>

   <!--
    favicon 
   -->
    <link rel="shortcut icon" href="/favicon.svg" type="image/svg+xml" >

    <!--
    google font link 
   -->
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Forum&display=swap" rel="stylesheet">

   <!--
    custom css link
   -->
   <link rel="stylesheet" href="/public/stylesheets/style.css">

    <!--
    preload images
   -->
    <link rel="preload" as="image" href="/public/images/hero-slider-1.jpeg">
    <link rel="preload" as="image" href="/public/images/hero-slider-2.png">
    <link rel="preload" as="image" href="/public/images/hero-slider-3.png">
    
   

  
</head>

<body class="reservation_body" id="body">
  <%- include('top_bar') %>


  <main>
    <section class="reservation" id="reservation">
        <div class="container" >

            <div class="form reservation-form bg-black-10">

                <form class="form-left" id="form_add">
                    <br>
                    <h2 class="headline-1 text-center">Online Reservation</h2>

                    <p class="form-text text-center">
                        Booking request <a href="tel:01773475814" class="link">01773475814</a>
                        or fill out the order form
                    </p>

                    <div class="input-wrapper">
                        <input type="text" name="first_name" id="first_name" placeholder="First Name" autocomplete="off" class="input-field">
                        
                        <input type="text" name="last_name" id="last_name"  placeholder="Last Name" autocomplete="off" class="input-field">

                        <input type="tel" name="phone" id="phone" autocomplete="off" placeholder="Phone Number" autocomplete="off" class="input-field">

                    </div>

                    <div class="input-wrapper three-cols"> 
                        <div class="icon-wrapper">
                            <ion-icon name="person-outline" aria-hidden="true"></ion-icon> 
                            
                            <select name="person" id="personNum" class="input-field">
                                <option value="1-Person">1 Person</option>
                                <option value="2-Person">2 Person</option>
                                <option value="3-Person">3 Person</option>
                                <option value="4-Person">4 Person</option>
                                <option value="5-Person">5 Person</option>
                                <option value="6-Person">6 Person</option>
                                <option value="7-Person">7 Person</option>
                            </select>

                            <ion-icon name="chevron-down" aria-hidden="true"></ion-icon>

                        </div>

                        <div class="icon-wrapper">
                            <ion-icon name="calendar-clear-outline" aria-hidden="true"></ion-icon>
                            
                            <input type="date" name="reservation-date" class="input-field">

                            <ion-icon name="chevron-down" aria-hidden="true"></ion-icon>

                        </div>

                        <div class="icon-wrapper">
                            <ion-icon name="time-outline" aria-hidden="true"></ion-icon>

                            <select name="time" id="time" class="input-field">
                                <option value="12:00 am">12 : 00 am</option>
                                <option value="01:00 pm">01 : 00 pm</option>
                                <option value="02:00 pm">02 : 00 pm</option>
                                <option value="03:00 pm">03 : 00 pm</option>
                                <option value="04:00 pm">04 : 00 pm</option>
                                <option value="05:00 pm">05 : 00 pm</option>
                                <option value="06:00 pm">06 : 00 pm</option>
                                <option value="07:00 pm">07 : 00 pm</option>
                                <option value="08:00 pm">08 : 00 pm</option>
                                <option value="09:00 pm">09 : 00 pm</option>
                                <option value="10:00 pm">10 : 00 pm</option>
                            </select>

                            <ion-icon name="chevron-down" aria-hidden="true"></ion-icon>
                        </div>

                    </div>

                    <textarea name="message" id="message" placeholder="Message" autocomplete="off" class="input-field"></textarea>
                    
                    <button type="submit" value="Submit" class="btn btn-secondary">
                        <span class="text text-1">Book A Table</span>

                        <span class="text text-2" aria-hidden="true">Book A Table</span>

                    </button>
                
                </form>

                <div class="form-right text-center" style="background-image: url('/public/images/form-pattern.png');">
                    <h2 class="headline-1 text-center">Contact Us</h2>
    
                    <p class="contact-label">Booking Request</p>
    
                    <a href="tel:01773475814" class="body-1 contact-number hover-underline">01773475814</a>
                    
                    <div class="separator"></div>

                    <p class="contact-label">Location</p>
    
                    <address class="body-4">
                        32 Oxford Street, Ripley, <br>
                        Derbyshire DE5 3AP.
                    </address>
    
                    <p class="contact-label">Working Hours</p>
    
                    <p class="body-4">
                        Tuesday to Sunday <br>
                        12.00 pm - 10.30 pm
                    </p>
    
                    <p class="contact-label">Collection Hours</p>
    
                    <p class="body-4">
                        Tuesday to Sunday <br>
                        12.00 pm - 10.30 pm
                    </p>
    
                    <p class="contact-label">Delivery Hours</p>
    
                    <p class="body-4">
                        Tuesday to Friday and Sunday <br>
                        04.00 pm - 10.30 pm
                    </p>
                </div>

            </div>

            
        </div>
     </section>
     
     <section class="reservation-table-section" style="padding: 40px; background-color: var(--eerie-black-2); color: white">
        <h2 class="headline-1 text-center">Your Reservations</h2>
        <table id="reservationTable" style="width: 100%; margin-top: 20px; border-collapse: collapse;">
          <thead>
            <tr style="background-color: var(--gold-crayola); color: var(--black);">
              <th style="padding: 12px;">Date</th>
              <th style="padding: 12px;">Time</th>
              <th style="padding: 12px;">People</th>
              <th style="padding: 12px;">Phone</th>
              <th style="padding: 12px;">Message</th>
              <th style="padding: 12px;">First Name</th>
              <th style="padding: 12px;">Last Name</th>
              <th style="padding: 12px;">Actions</th>
            </tr>
          </thead>
          <tbody id="reservationBody">
            
          </tbody>
        </table>
    </section>

    <section class="reservation" id="reservation">
        <div class="container" style="display: none;">

            <div class="form reservation-form bg-black-10" >

                <form class="form-left" id="form_update" >
                    <a class="headline-1 text-center" href="/home_logged_in">CLICK FOR GO TO HOME PAGE </a>
                    <br>
                    <h1 class="headline-1 text-center" style="margin-block-end: 8px;">Update Reservation</h2>
                    <br>

                    <div class="input-wrapper">
                        <input type="text" name="first_name" id="first_name" placeholder="First Name" autocomplete="off" class="input-field">
                        
                        <input type="text" name="last_name" id="last_name"  placeholder="Last Name" autocomplete="off" class="input-field">

                        <input type="tel" name="phone" id="phone" autocomplete="off" placeholder="Phone Number" autocomplete="off" class="input-field">

                    </div>

                    <div class="input-wrapper three-cols"> 
                        <div class="icon-wrapper">
                            <ion-icon name="person-outline" aria-hidden="true"></ion-icon> 
                            
                            <select name="person" id="personNum" class="input-field">
                                <option value="1-Person">1 Person</option>
                                <option value="2-Person">2 Person</option>
                                <option value="3-Person">3 Person</option>
                                <option value="4-Person">4 Person</option>
                                <option value="5-Person">5 Person</option>
                                <option value="6-Person">6 Person</option>
                                <option value="7-Person">7 Person</option>
                            </select>

                            <ion-icon name="chevron-down" aria-hidden="true"></ion-icon>

                        </div>

                        <div class="icon-wrapper">
                            <ion-icon name="calendar-clear-outline" aria-hidden="true"></ion-icon>
                            
                            <input type="date" name="reservation-date" class="input-field">

                            <ion-icon name="chevron-down" aria-hidden="true"></ion-icon>

                        </div>

                        <div class="icon-wrapper">
                            <ion-icon name="time-outline" aria-hidden="true"></ion-icon>

                            <select name="time" id="time" class="input-field">
                                <option value="12:00 am">12 : 00 am</option>
                                <option value="01:00 pm">01 : 00 pm</option>
                                <option value="02:00 pm">02 : 00 pm</option>
                                <option value="03:00 pm">03 : 00 pm</option>
                                <option value="04:00 pm">04 : 00 pm</option>
                                <option value="05:00 pm">05 : 00 pm</option>
                                <option value="06:00 pm">06 : 00 pm</option>
                                <option value="07:00 pm">07 : 00 pm</option>
                                <option value="08:00 pm">08 : 00 pm</option>
                                <option value="09:00 pm">09 : 00 pm</option>
                                <option value="10:00 pm">10 : 00 pm</option>
                            </select>

                            <ion-icon name="chevron-down" aria-hidden="true"></ion-icon>
                        </div>

                    </div>

                    <textarea name="message" id="message" placeholder="Message" autocomplete="off" class="input-field"></textarea>
                    
                    <button type="submit" value="Submit" class="btn btn-secondary">
                        <span class="text text-1">Update Reservation</span>

                        <span class="text text-2" aria-hidden="true">Update Reservation</span>

                    </button>
                
                </form>

            </div>

            
        </div>
     </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  

  <script>
        document.querySelector("#form_add").addEventListener("submit", async (e) =>{
            e.preventDefault();

            const token = localStorage.getItem("accessToken");
            if (!token) {
                alert("Please login first.");
                window.location.href = "/auth";
                return;
            }
            
            const form = e.target;
            const first_name = form.first_name.value;
            const last_name = form.last_name.value;
            const phone = form.phone.value;
            const personNum = form.person.value;
            const reservationTime = form["reservation-date"].value;
            const reservationHour = form.time.value;
            const message = form.message.value;
                    
            const body = {
                first_name,
                last_name,
                phone,
                personNum,
                reservationTime,
                reservationHour,
                message
            };
          
            try {
                const res = await axios.post("/api/reservations/add", body, {
                  headers: {
                    Authorization: `Bearer ${token}`,
                    //"Content-Type": "application/json"
                  }
                });
                alert("Reservation successful!");
                loadReservations();
                console.log(res.data);
            } catch (err) {
                console.error("Reservation failed:", err);
                console.log(err);
                alert(err.response?.data?.error?.description || "Reservation failed");
            }
            });


    </script>

    <script>
    async function loadReservations() {
      const token = localStorage.getItem("accessToken");
      if (!token) {
        return;
      }

      try {

        const res = await axios.get("/api/reservations", {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });

        const reservations = res.data.data;
        const tbody = document.getElementById("reservationBody");
        tbody.innerHTML = "";

        reservations.forEach((r) => {
          const tr = document.createElement("tr");
          const dateObj = new Date(r.reservationTime);
          const formattedDate = `${String(dateObj.getDate()).padStart(2, '0')}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${dateObj.getFullYear()}`;
  
          const formattedHour = r.reservationHour?.slice(0, 5) || "--:--";

          tr.innerHTML = `
            <td style="padding: 8px;">${formattedDate}</td>
            <td style="padding: 8px;">${formattedHour}</td>
            <td style="padding: 8px;">${r.personNum}</td>
            <td style="padding: 8px;">${r.phone || "-"}</td>
            <td style="padding: 8px;">${r.message || ""}</td>
            <td style="padding: 8px;">${r.first_name || r.created_by?.first_name}</td>
            <td style="padding: 8px;">${r.last_name || r.created_by?.last_name}</td>
            <td style="padding: 8px;">
              <button  style="color: white" onclick="editReservation('${r._id}')">Edit</button>
              <button style="color: white" onclick="deleteReservation('${r._id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loading reservations:", err);
      }
    }

    async function deleteReservation(id) {
      const token = localStorage.getItem("accessToken");
      if (!token) return;

      if (!confirm("Are you sure you want to delete this reservation?")) return;

      try {
        await axios.post("/api/reservations/delete", { _id: id }, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });
        alert("Deleted successfully");
        loadReservations();
      } catch (err) {
        console.log(err);
        console.error("Delete failed");
      }
    }

    async function deleteReservation(id) {
      const token = localStorage.getItem("accessToken");
      if (!token) return;

      if (!confirm("Are you sure you want to delete this reservation?")) return;

      try {
        await axios.post("/api/reservations/delete", { _id: id }, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });
        alert("Deleted successfully");
        loadReservations();
      } catch (err) {
        console.log(err);
        console.error("Delete failed");
      }
    }

    function editReservation(id) {
      const token =localStorage.getItem("accessToken");
      if(!token) return;
      const formDiv = document.getElementById("form_update");

      formDiv.closest(".container").style.display = "block";

      formDiv.addEventListener("submit", async(e) =>{
          e.preventDefault();

          const form = e.target;
          const first_name = form.first_name.value;
          const last_name = form.last_name.value;
          const phone = form.phone.value;
          const personNum = form.person.value;
          const reservationTime = form["reservation-date"].value;
          const reservationHour = form.time.value;
          const message = form.message.value;

          const body = {
                _id: id,
                first_name,
                last_name,
                phone,
                personNum,
                reservationTime,
                reservationHour,
                message
          };
          try{
            const res = await axios.post("api/reservations/update", body ,{
                  headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json"
                  }
                });
                formDiv.closest(".container").style.display = "none";
                alert("update is successful!");
                loadReservations();
                console.log(res.data);
            } catch (err) {
                console.error("update failed:", err);
                alert(err.response?.data?.error?.description || "update failed");
            }
      });
      
    }

    window.addEventListener("DOMContentLoaded", loadReservations);

    
    </script>

    

  <%- include('script') %>
</body>
</html>
